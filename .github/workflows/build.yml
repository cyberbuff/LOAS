name: Build OSAScript Applications
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

on:
  workflow_dispatch:
    inputs:
      bump_version:
        description: 'Bump version type'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major
      custom_version:
        description: 'Custom version (e.g., 1.2.3)'
        required: false
        type: string

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: "Set up Python"
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"

      - name: Install Python dependencies
        run: uv sync

      - name: Run complete build process
        run: uv run main.py build

      - name: Gather stats
        run: |
          uv run main.py stats

      - name: Run pre-commit
        run: uv run pre-commit run --all-files

      - name: Bump version
        id: bump_version
        run: |
          if [ "${{ github.event.inputs.bump_version }}" != "none" ]; then
            if [ "${{ github.event.inputs.custom_version }}" != "" ]; then
              # Set custom version
              NEW_VERSION="${{ github.event.inputs.custom_version }}"
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

              # Update both files with custom version using bump2version
              uv run bump2version --new-version $NEW_VERSION --allow-dirty
            else
              # Bump version based on type using bump2version
              BUMP_TYPE="${{ github.event.inputs.bump_version }}"
              echo "Bumping $BUMP_TYPE version"

              # Get the new version that would be created (dry run)
              NEW_VERSION=$(uv run bump2version --dry-run --list $BUMP_TYPE | grep new_version | sed 's/.*=//')
              echo "New version: $NEW_VERSION"
              echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

              # Actually bump the version
              uv run bump2version --allow-dirty $BUMP_TYPE
            fi

            # Push the changes (bump2version handles the commit)
            git push
          else
            # Use run number as version if no bump specified
            echo "version=v${{ github.run_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.bump_version.outputs.version }}
          release_name: Release ${{ steps.bump_version.outputs.version }}
          body: |
            Automated build release

            ## Artifacts
            - **OSAScript files**: AppleScript source files
            - **Compiled applications**: Built application bundles
            - **Swift files**: Swift source code
            - **Compiled binaries**: Executable binaries

            Download the files above to get the complete build output.
          draft: false
          prerelease: false

      - name: Upload OSAScript files to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./osascripts/
          asset_name: osascripts
          asset_content_type: application/octet-stream

      - name: Upload compiled applications to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./releases/
          asset_name: apps
          asset_content_type: application/octet-stream

      - name: Upload swift files to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./swift/
          asset_name: swift
          asset_content_type: application/octet-stream

      - name: Upload compiled binaries to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./binaries/
          asset_name: binaries
          asset_content_type: application/octet-stream
